class T{constructor(t){this.properties=t??[]}get(t){const r=this.properties.filter(o=>o.name===t).map(o=>o.value);if(r.length>1)throw new Error('Expected only one property to be named "'+t+'"');if(r.length!==0)return r[0]}getString(t){return this.getByType(t,"string")}getNumber(t){return this.getByType(t,"number")}getBoolean(t){return this.getByType(t,"boolean")}getByType(t,r){const o=this.get(t);if(o!==void 0){if(r!=="json"&&typeof o!==r)throw new Error('Expected property "'+t+'" to have type "'+r+'"');return o}}mustGetString(t){return this.mustGetByType(t,"string")}mustGetNumber(t){return this.mustGetByType(t,"number")}mustGetBoolean(t){return this.mustGetByType(t,"boolean")}mustGetByType(t,r){const o=this.get(t);if(o===void 0)throw new Error('Property "'+t+'" is missing');if(r!=="json"&&typeof o!==r)throw new Error('Expected property "'+t+'" to have type "'+r+'"');return o}getType(t){const r=this.properties.filter(o=>o.name===t).map(o=>o.type);if(r.length>1)throw new Error('Expected only one property to be named "'+t+'"');if(r.length!==0)return r[0]}}const G="https://unpkg.com/@workadventure/scripting-api-extra@1.4.6/dist";class te{constructor(t){this.name=t.name,this.x=t.x,this.y=t.y,this.properties=new T(t.properties)}get isReadable(){const t=this.properties.getString("readableBy");return t?WA.player.tags.includes(t):!0}get isWritable(){const t=this.properties.getString("writableBy");return t?WA.player.tags.includes(t):!0}}function I(e){const t=e?"#"+e.join():"";WA.nav.openCoWebSite(G+"/configuration.html"+t)}async function re(e,t){const r=await WA.room.getTiledMap(),o=new Map;return H(r.layers,o,e,t),o}function H(e,t,r,o){for(const n of e)if(n.type==="objectgroup"){for(const s of n.objects)if(s.type==="variable"||s.class==="variable"){if(r&&n.name!==r||o&&!o.includes(s.name))continue;t.set(s.name,new te(s))}}else n.type==="group"&&H(n.layers,t,r,o)}let U;async function P(){return U===void 0&&(U=oe()),U}async function oe(){return ne(await WA.room.getTiledMap())}function ne(e){const t=new Map;return K(e.layers,"",t),t}function K(e,t,r){for(const o of e)o.type==="group"?K(o.layers,t+o.name+"/",r):(o.name=t+o.name,r.set(o.name,o))}async function se(){const e=await P(),t=[];for(const r of e.values())if(r.type==="objectgroup")for(const o of r.objects)(o.type==="area"||o.class==="area")&&t.push(o);return t}function ie(e){let t=1/0,r=1/0,o=0,n=0;const s=e.data;if(typeof s=="string")throw new Error("Unsupported tile layer data stored as string instead of CSV");for(let i=0;i<e.height;i++)for(let a=0;a<e.width;a++)s[a+i*e.width]!==0&&(t=Math.min(t,a),n=Math.max(n,a),r=Math.min(r,i),o=Math.max(o,i));return{top:r,left:t,right:n+1,bottom:o+1}}function J(e){let t=1/0,r=1/0,o=0,n=0;for(const s of e){const i=ie(s);i.left<t&&(t=i.left),i.top<r&&(r=i.top),i.right>n&&(n=i.right),i.bottom>o&&(o=i.bottom)}return{top:r,left:t,right:n,bottom:o}}/*!
* mustache.js - Logic-less {{mustache}} templates with JavaScript
* http://github.com/janl/mustache.js
*/var ae=Object.prototype.toString,w=Array.isArray||function(e){return ae.call(e)==="[object Array]"};function B(e){return typeof e=="function"}function le(e){return w(e)?"array":typeof e}function V(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function N(e,t){return e!=null&&typeof e=="object"&&t in e}function ce(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}var ue=RegExp.prototype.test;function pe(e,t){return ue.call(e,t)}var fe=/\S/;function he(e){return!pe(fe,e)}var ge={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function ye(e){return String(e).replace(/[&<>"'`=\/]/g,function(t){return ge[t]})}var de=/\s*/,me=/\s+/,_=/\s*=/,be=/\s*\}/,ve=/#|\^|\/|>|\{|&|=|!/;function Ae(e,t){if(!e)return[];var r=!1,o=[],n=[],s=[],i=!1,a=!1,l="",u=0;function y(){if(i&&!a)for(;s.length;)delete n[s.pop()];else s=[];i=!1,a=!1}var m,b,L;function S(v){if(typeof v=="string"&&(v=v.split(me,2)),!w(v)||v.length!==2)throw new Error("Invalid tags: "+v);m=new RegExp(V(v[0])+"\\s*"),b=new RegExp("\\s*"+V(v[1])),L=new RegExp("\\s*"+V("}"+v[1]))}S(t||h.tags);for(var c=new x(e),d,f,g,C,k,A;!c.eos();){if(d=c.pos,g=c.scanUntil(m),g)for(var M=0,ee=g.length;M<ee;++M)C=g.charAt(M),he(C)?(s.push(n.length),l+=C):(a=!0,r=!0,l+=" "),n.push(["text",C,d,d+1]),d+=1,C===`
`&&(y(),l="",u=0,r=!1);if(!c.scan(m))break;if(i=!0,f=c.scan(ve)||"name",c.scan(de),f==="="?(g=c.scanUntil(_),c.scan(_),c.scanUntil(b)):f==="{"?(g=c.scanUntil(L),c.scan(be),c.scanUntil(b),f="&"):g=c.scanUntil(b),!c.scan(b))throw new Error("Unclosed tag at "+c.pos);if(f==">"?k=[f,g,d,c.pos,l,u,r]:k=[f,g,d,c.pos],u++,n.push(k),f==="#"||f==="^")o.push(k);else if(f==="/"){if(A=o.pop(),!A)throw new Error('Unopened section "'+g+'" at '+d);if(A[1]!==g)throw new Error('Unclosed section "'+A[1]+'" at '+d)}else f==="name"||f==="{"||f==="&"?a=!0:f==="="&&S(g)}if(y(),A=o.pop(),A)throw new Error('Unclosed section "'+A[1]+'" at '+c.pos);return we(We(n))}function We(e){for(var t=[],r,o,n=0,s=e.length;n<s;++n)r=e[n],r&&(r[0]==="text"&&o&&o[0]==="text"?(o[1]+=r[1],o[3]=r[3]):(t.push(r),o=r));return t}function we(e){for(var t=[],r=t,o=[],n,s,i=0,a=e.length;i<a;++i)switch(n=e[i],n[0]){case"#":case"^":r.push(n),o.push(n),r=n[4]=[];break;case"/":s=o.pop(),s[5]=n[2],r=o.length>0?o[o.length-1][4]:t;break;default:r.push(n)}return t}function x(e){this.string=e,this.tail=e,this.pos=0}x.prototype.eos=function(){return this.tail===""};x.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};x.prototype.scanUntil=function(e){var t=this.tail.search(e),r;switch(t){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=r.length,r};function W(e,t){this.view=e,this.cache={".":this.view},this.parent=t}W.prototype.push=function(e){return new W(e,this)};W.prototype.lookup=function(e){var t=this.cache,r;if(t.hasOwnProperty(e))r=t[e];else{for(var o=this,n,s,i,a=!1;o;){if(e.indexOf(".")>0)for(n=o.view,s=e.split("."),i=0;n!=null&&i<s.length;)i===s.length-1&&(a=N(n,s[i])||ce(n,s[i])),n=n[s[i++]];else n=o.view[e],a=N(o.view,e);if(a){r=n;break}o=o.parent}t[e]=r}return B(r)&&(r=r.call(this.view)),r};function p(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}p.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};p.prototype.parse=function(e,t){var r=this.templateCache,o=e+":"+(t||h.tags).join(":"),n=typeof r<"u",s=n?r.get(o):void 0;return s==null&&(s=Ae(e,t),n&&r.set(o,s)),s};p.prototype.render=function(e,t,r,o){var n=this.getConfigTags(o),s=this.parse(e,n),i=t instanceof W?t:new W(t,void 0);return this.renderTokens(s,i,r,e,o)};p.prototype.renderTokens=function(e,t,r,o,n){for(var s="",i,a,l,u=0,y=e.length;u<y;++u)l=void 0,i=e[u],a=i[0],a==="#"?l=this.renderSection(i,t,r,o,n):a==="^"?l=this.renderInverted(i,t,r,o,n):a===">"?l=this.renderPartial(i,t,r,n):a==="&"?l=this.unescapedValue(i,t):a==="name"?l=this.escapedValue(i,t,n):a==="text"&&(l=this.rawValue(i)),l!==void 0&&(s+=l);return s};p.prototype.renderSection=function(e,t,r,o,n){var s=this,i="",a=t.lookup(e[1]);function l(m){return s.render(m,t,r,n)}if(a){if(w(a))for(var u=0,y=a.length;u<y;++u)i+=this.renderTokens(e[4],t.push(a[u]),r,o,n);else if(typeof a=="object"||typeof a=="string"||typeof a=="number")i+=this.renderTokens(e[4],t.push(a),r,o,n);else if(B(a)){if(typeof o!="string")throw new Error("Cannot use higher-order sections without the original template");a=a.call(t.view,o.slice(e[3],e[5]),l),a!=null&&(i+=a)}else i+=this.renderTokens(e[4],t,r,o,n);return i}};p.prototype.renderInverted=function(e,t,r,o,n){var s=t.lookup(e[1]);if(!s||w(s)&&s.length===0)return this.renderTokens(e[4],t,r,o,n)};p.prototype.indentPartial=function(e,t,r){for(var o=t.replace(/[^ \t]/g,""),n=e.split(`
`),s=0;s<n.length;s++)n[s].length&&(s>0||!r)&&(n[s]=o+n[s]);return n.join(`
`)};p.prototype.renderPartial=function(e,t,r,o){if(r){var n=this.getConfigTags(o),s=B(r)?r(e[1]):r[e[1]];if(s!=null){var i=e[6],a=e[5],l=e[4],u=s;a==0&&l&&(u=this.indentPartial(s,l,i));var y=this.parse(u,n);return this.renderTokens(y,t,r,u,o)}}};p.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(r!=null)return r};p.prototype.escapedValue=function(e,t,r){var o=this.getConfigEscape(r)||h.escape,n=t.lookup(e[1]);if(n!=null)return typeof n=="number"&&o===h.escape?String(n):o(n)};p.prototype.rawValue=function(e){return e[1]};p.prototype.getConfigTags=function(e){return w(e)?e:e&&typeof e=="object"?e.tags:void 0};p.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!w(e))return e.escape};var h={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){E.templateCache=e},get templateCache(){return E.templateCache}},E=new p;h.clearCache=function(){return E.clearCache()};h.parse=function(e,t){return E.parse(e,t)};h.render=function(e,t,r,o){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+le(e)+'" was given as the first argument for mustache#render(template, view, partials)');return E.render(e,t,r,o)};h.escape=ye;h.Scanner=x;h.Context=W;h.Writer=p;class X{constructor(t,r){this.template=t,this.state=r,this.ast=h.parse(t)}getValue(){return this.value===void 0&&(this.value=h.render(this.template,this.state)),this.value}onChange(t){const r=[];for(const o of this.getUsedVariables().values())r.push(this.state.onVariableChange(o).subscribe(()=>{const n=h.render(this.template,this.state);n!==this.value&&(this.value=n,t(this.value))}));return{unsubscribe:()=>{for(const o of r)o.unsubscribe()}}}isPureString(){return this.ast.length===0||this.ast.length===1&&this.ast[0][0]==="text"}getUsedVariables(){const t=new Set;return this.recursiveGetUsedVariables(this.ast,t),t}recursiveGetUsedVariables(t,r){for(const o of t){const n=o[0],s=o[1],i=o[4];["name","&","#","^"].includes(n)&&r.add(s),i!==void 0&&typeof i!="string"&&this.recursiveGetUsedVariables(i,r)}}}async function Se(){var e;const t=await se();for(const r of t){const o=(e=r.properties)!==null&&e!==void 0?e:[];for(const n of o){if(n.type==="int"||n.type==="bool"||n.type==="object"||typeof n.value!="string")continue;const s=new X(n.value,WA.state);if(s.isPureString())continue;const i=s.getValue();await q(r.name,n.name,i),s.onChange(async a=>{await q(r.name,n.name,a)})}}}async function Ce(){var e;const t=await P();for(const[r,o]of t.entries())if(o.type!=="objectgroup"){const n=(e=o.properties)!==null&&e!==void 0?e:[];for(const s of n){if(s.type==="int"||s.type==="bool"||s.type==="object"||typeof s.value!="string")continue;const i=new X(s.value,WA.state);if(i.isPureString())continue;const a=i.getValue();$(r,s.name,a),i.onChange(l=>{$(r,s.name,l)})}}}async function q(e,t,r){console.log(e),(await WA.room.area.get(e)).setProperty(t,r)}function $(e,t,r){WA.room.setProperty(e,t,r),t==="visible"&&(r?WA.room.showLayer(e):WA.room.hideLayer(e))}let j,O=0,R=0;function z(e){if(WA.state[e.name]){let t=e.properties.mustGetString("openLayer");for(const r of t.split(`
`))WA.room.showLayer(r);t=e.properties.mustGetString("closeLayer");for(const r of t.split(`
`))WA.room.hideLayer(r)}else{let t=e.properties.mustGetString("openLayer");for(const r of t.split(`
`))WA.room.hideLayer(r);t=e.properties.mustGetString("closeLayer");for(const r of t.split(`
`))WA.room.showLayer(r)}}function Te(e){const t=e.properties.getString("openSound"),r=e.properties.getNumber("soundRadius");let o=1;if(r){const n=Z(e.properties.mustGetString("openLayer").split(`
`));if(n>r)return;o=1-n/r}t&&WA.sound.loadSound(t).play({volume:o})}function Ee(e){const t=e.properties.getString("closeSound"),r=e.properties.getNumber("soundRadius");let o=1;if(r){const n=Z(e.properties.mustGetString("closeLayer").split(`
`));if(n>r)return;o=1-n/r}t&&WA.sound.loadSound(t).play({volume:o})}function Y(e){return e.map(t=>j.get(t)).filter(t=>(t==null?void 0:t.type)==="tilelayer")}function Z(e){const t=Y(e),r=J(t),o=((r.right-r.left)/2+r.left)*32,n=((r.bottom-r.top)/2+r.top)*32;return Math.sqrt(Math.pow(O-o,2)+Math.pow(R-n,2))}function Pe(e){WA.state.onVariableChange(e.name).subscribe(()=>{WA.state[e.name]?Te(e):Ee(e),z(e)}),z(e)}function xe(e,t,r,o){const n=e.name;let s,i,a=!1;const l=r.getString("tag");let u=!0;l&&!WA.player.tags.includes(l)&&(u=!1);const y=!!l;function m(){var c;s&&s.remove(),s=WA.ui.displayActionMessage({message:(c=r.getString("closeTriggerMessage"))!==null&&c!==void 0?c:"Press SPACE to close the door",callback:()=>{WA.state[t.name]=!1,b()}})}function b(){var c;s&&s.remove(),s=WA.ui.displayActionMessage({message:(c=r.getString("openTriggerMessage"))!==null&&c!==void 0?c:"Press SPACE to open the door",callback:()=>{WA.state[t.name]=!0,m()}})}function L(c){const d=J(Y(t.properties.mustGetString("closeLayer").split(`
`)));i=WA.room.website.create({name:"doorKeypad"+c,url:o+"/keypad.html#"+encodeURIComponent(c),position:{x:d.right*32,y:d.top*32,width:32*3,height:32*4},allowApi:!0})}function S(){i&&(WA.room.website.delete(i.name),i=void 0)}WA.room.onEnterLayer(n).subscribe(()=>{if(a=!0,r.getBoolean("autoOpen")&&u){WA.state[t.name]=!0;return}if(!WA.state[t.name]&&(y&&!u||!y)&&(r.getString("code")||r.getString("codeVariable"))){L(n);return}u&&(WA.state[t.name]?m():b())}),WA.room.onLeaveLayer(n).subscribe(()=>{a=!1,r.getBoolean("autoClose")&&(WA.state[t.name]=!1),s&&s.remove(),S()}),WA.state.onVariableChange(t.name).subscribe(()=>{a&&(!r.getBoolean("autoClose")&&WA.state[t.name]===!0&&m(),i&&WA.state[t.name]===!0&&S(),!r.getBoolean("autoOpen")&&WA.state[t.name]===!1&&b())})}function Le(e){const t=e.properties.mustGetString("bellSound"),r=e.properties.getNumber("soundRadius");let o=1;if(r){const n=Math.sqrt(Math.pow(e.x-O,2)+Math.pow(e.y-R,2));if(n>r)return;o=1-n/r}WA.sound.loadSound(t).play({volume:o})}function ke(e){WA.state[e.name]===void 0&&(WA.state[e.name]=0),WA.state.onVariableChange(e.name).subscribe(()=>{WA.state[e.name]&&Le(e)})}function Me(e,t,r){let o;const n=t.getString("bellPopup");WA.room.onEnterLayer(r).subscribe(()=>{var s;n?o=WA.ui.openPopup(n,"",[{label:(s=t.getString("bellButtonText"))!==null&&s!==void 0?s:"Ring",callback:()=>{WA.state[e]=WA.state[e]+1}}]):WA.state[e]=WA.state[e]+1}),WA.room.onLeaveLayer(r).subscribe(()=>{o&&(o.close(),o=void 0)})}async function Ue(e){e=e??G;const t=await re();j=await P();for(const r of t.values())r.properties.get("door")&&Pe(r),r.properties.get("bell")&&ke(r);for(const r of j.values()){const o=new T(r.properties),n=o.getString("doorVariable");if(n&&r.type==="tilelayer"){const i=t.get(n);if(i===void 0)throw new Error('Cannot find variable "'+n+'" referred in the "doorVariable" property of layer "'+r.name+'"');xe(r,i,o,e)}const s=o.getString("bellVariable");s&&Me(s,o,r.name)}WA.player.onPlayerMove(r=>{O=r.x,R=r.y})}function Ve(e,t){const r=e.getString("bindVariable");if(r){const o=e.get("enterValue"),n=e.get("leaveValue"),s=e.getString("triggerMessage"),i=e.getString("tag");je(r,t,o,n,s,i)}}function je(e,t,r,o,n,s){s&&!WA.player.tags.includes(s)||(r!==void 0&&WA.room.onEnterLayer(t).subscribe(()=>{n||(WA.state[e]=r)}),o!==void 0&&WA.room.onLeaveLayer(t).subscribe(()=>{WA.state[e]=o}))}async function Ge(){const e=await P();for(const t of e.values()){const r=new T(t.properties);Ve(r,t.name)}}let D;async function Be(e){const t=await WA.room.getTiledMap();e=e??G,D=await P();const r=t.layers.find(o=>o.name==="configuration");if(r){const o=new T(r.properties).getString("tag");(!o||WA.player.tags.includes(o))&&WA.ui.registerMenuCommand("Configure the room",()=>{WA.nav.openCoWebSite(e+"/configuration.html",!0)});for(const n of D.values()){const s=new T(n.properties),i=s.getString("openConfig");i&&n.type==="tilelayer"&&Oe(i.split(","),n.name,s)}}}function Oe(e,t,r){let o;const n=r.getString("openConfigAdminTag");let s=!0;n&&!WA.player.tags.includes(n)&&(s=!1);function i(){var l;o&&o.remove(),o=WA.ui.displayActionMessage({message:(l=r.getString("openConfigTriggerMessage"))!==null&&l!==void 0?l:"Press SPACE or touch here to configure",callback:()=>I(e)})}function a(){WA.nav.closeCoWebSite()}WA.room.onEnterLayer(t).subscribe(()=>{const l=r.getString("openConfigTrigger");s&&(l&&l==="onaction"?i():I(e))}),WA.room.onLeaveLayer(t).subscribe(()=>{o&&o.remove(),a()})}function Re(){return WA.onInit().then(()=>{Ue().catch(e=>console.error(e)),Ge().catch(e=>console.error(e)),Be().catch(e=>console.error(e)),Ce().catch(e=>console.error(e)),Se().catch(e=>console.error(e))}).catch(e=>console.error(e))}console.log("Script started successfully");var Ie=WA.sound.loadSound("../audio/japanese_school_bell.mp3"),Ne={volume:1,loop:!1,rate:3,detune:0,delay:0,seek:0,mute:!1},Q=WA.sound.loadSound("../audio/bgm.mp3"),_e={volume:.05,loop:!0,rate:1,detune:0,delay:0,seek:0,mute:!1};WA.onInit().then(()=>{De(),Fe(),He(),Ke()}).catch(e=>console.error(e));function qe(){Ie.play(Ne)}function F(){WA.state.bellIsOn=!WA.state.bellIsOn}function $e(){Q.play(_e)}function ze(){Q.stop()}function De(){console.log("Scripting Room API ready"),console.log("Player tags: ",WA.player.tags),Re().then(()=>{console.log("Scripting API Extra ready")}).catch(e=>console.error(e))}function Fe(){WA.room.onEnterLayer("Util/bgmLayer").subscribe(()=>{WA.ui.openPopup("bgmPopUp","Hintergrundmusik abspielen",[{label:"Spielen",className:"success",callback:e=>{$e(),e.close()}},{label:"Stoppen",className:"primary",callback:e=>{ze(),e.close()}}])})}function He(){WA.room.onEnterLayer("Util/leverLayer").subscribe(()=>{WA.ui.openPopup("klingelPopUp","Möchtest du die Glocke läuten",[{label:"Läuten",className:"success",callback:e=>{F(),F(),e.close()}},{label:"Schließen",className:"primary",callback:e=>{e.close()}}])}),WA.state.onVariableChange("bellIsOn").subscribe(e=>{e&&qe()})}function Ke(){WA.room.onEnterLayer("Util/switchTestLayer").subscribe(()=>{WA.ui.openPopup("switchTestPopUp","Test ändern auf",[{label:"Einführung",className:"success",callback:e=>{Je(),e.close()}},{label:"Abschluss",className:"success",callback:e=>{Xe(),e.close()}},{label:"Schließen",className:"primary",callback:e=>{e.close()}}])})}function Je(){WA.room.setProperty("Util/urlOnyxTest","openWebsite","https://bildungsportal.sachsen.de/opal/auth/RepositoryEntry/40617082880?6"),WA.room.setProperty("Util/urlOnyxTest","openWebsiteTriggerMessage","Leertaste um den Einführungstest zu beginnen")}function Xe(){WA.room.setProperty("Util/urlOnyxTest","openWebsite","https://bildungsportal.sachsen.de/opal/auth/RepositoryEntry/40713125888?4"),WA.room.setProperty("Util/urlOnyxTest","openWebsiteTriggerMessage","Leertaste um den Abschlusstest zu beginnen")}
